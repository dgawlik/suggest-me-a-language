<!DOCTYPE html>
<html data-theme="light">
<head>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
</head>
<body>
    <main x-data="state" class="container">
        <h1 style="font-family: 'Lobster'; font-size: 56px;"> Suggest me <br> a language</h1>

        <div style="display:inline-block; width:200px;">
            <details role="list">
                <summary aria-haspopup="listbox" role="button">
                    I ...
                </summary>
                <ul role="listbox">
                    <li x-on:click="showBrowse = true; showFillCriteria = false; showTree = false;"><a>want to browse</a></li>
                    <li x-on:click="showBrowse = false; showFillCriteria = true; showTree = false;"><a>know the criteria</a></li>
                    <li x-on:click="showBrowse = false; showFillCriteria = false; showTree = true;"><a>need guidance</a></li>
                </ul>
            </details>
        </div>

        <div id="browse" x-show="showBrowse">
            <ul >
                <template x-for="language in languages" :key="language.name">
                    <article x-data="{showCard: false}"  x-on:click="showCard = ! showCard">
                        <h2 x-text="language.name"></h2>
                        <div x-show="showCard">
                            <p x-text="language.description"></p>
                            <ul>
                                <template x-for="feature in language.features" >
                                    <template x-if="feature.value > 0">
                                        <li x-text="featureDescription(feature)"></li>
                                    </template>
                                </template>
                            </ul>
                        </div>
                    </article>
                </template>
            </ul>
        </div>

        <div id="fillCriteria" x-show="showFillCriteria">
            <div>
                <h3>Fill in criteria</h3>
                <template x-for="feature in features" :key="feature.id">
                    <label x-data="{active: false, value: ''}">
                        <input x-on:click="[active, criteria, filteredLanguages] = updateLanguages(active, feature, value, criteria, languages);"
                               type="checkbox" name="switch" role="switch">
                        <span x-text="feature.description"></span>
                        <template x-if="feature.fieldType.min">
                            <input style="display: inline-block; width: 150px;" type="text" placeholder="at least" x-model="value">
                        </template>
                    </label>
                </template>
            </div>
            <div>
                <h3>Languages</h3>
                <ul>
                    <template x-for="language in filteredLanguages" :key="language.name">
                        <article x-data="{showCard: false}" x-on:click="showCard = ! showCard">
                            <h2  x-text="language.name"></h2>
                            <div x-show="showCard">
                                <p x-text="language.description"></p>
                                <ul>
                                    <template x-for="feature in language.features" >
                                        <template x-if="feature.value > 0">
                                            <li x-text="featureDescription(feature)"></li>
                                        </template>
                                    </template>
                                </ul>
                            </div>
                        </article>
                    </template>
                </ul>
            </div>
        </div>

        <div id="showTree" x-show="showTree">
            <div style="margin-bottom: 40px;">
                <h3>Answer questions</h3>
                <ul x-html="alreadyAnswered">

                </ul>
                <p x-text="currentQuestion"></p>
                <a  href="#" role="button" x-on:click="[currentQuestion, alreadyAnswered, tree] = traverseTreeLeft(tree, alreadyAnswered);">No</a>
                <a  href="#" role="button" x-on:click="[currentQuestion, alreadyAnswered, tree, treeFilteredLanguages] = traverseTreeRight(tree, alreadyAnswered, treeFilteredLanguages);">Yes</a>
            </div>
            <div >
                <h3>Languages</h3>
                <ul>
                    <template x-for="language in treeFilteredLanguages" :key="language.name">
                        <article x-data="{showCard: false}" x-on:click="showCard = ! showCard">
                            <h2  x-text="language.name"></h2>
                            <div x-show="showCard">
                                <p x-text="language.description"></p>
                                <ul>
                                    <template x-for="feature in language.features" >
                                        <template x-if="feature.value > 0">
                                            <li x-text="featureDescription(feature)"></li>
                                        </template>
                                    </template>
                                </ul>
                            </div>
                        </article>
                    </template>
                </ul>
            </div>
        </div>


    </main>

    <script type="application/javascript">
        const state = {
            languages: [],
            features: [],
            showBrowse: false,
            showFillCriteria: false,
            showTree: false,
            criteria: [],
            filteredLanguages: [],
            treeFilteredLanguages: [],
            treeCriteria: [],
            tree: null,
            alreadyAnswered: "",
            currentQuestion: "",

            init() {
                this.get()
            },

            async get() {
                let r = await fetch('/languages')
                r = await r.json()

                this.languages = r
                this.filteredLanguages = r
                this.treeFilteredLanguages = r

                let f = await fetch('/features')
                f = await f.json()

                this.features = f;
                this.criteria = [];

                let t = await fetch('/tree')
                t = await t.json()

                this.tree = t
                this.currentQuestion = this.question(this.tree);
            },

            updateLanguages(isOn, feature, value, criteria, langs) {
                let isOn2 = !isOn;

                let criteria2 = null;
                if(isOn2) {
                    criteria2 =  criteria.concat([{value: feature.fieldType.min ? value : 1, feature}]);
                }
                else {
                    criteria2 = criteria.filter(item => item.feature.id !== feature.id)
                }
                let langs2 = langs.filter(item => {
                    return criteria2.every( c => {
                         return item.features.some( f => c.feature.id == f.feature.id && c.value <= f.value );
                    });
                });

                return [isOn2, criteria2, langs2];
            },

            question(tree)  {
                if(tree.rule.feature.fieldType.min) {
                    return `Do you want ${tree.rule.feature.description} for at least ${tree.rule.value}?`;
                }
                else {
                    return `Do you want ${tree.rule.feature.description}?`
                }
            },

            traverseTreeRight(tree, alreadyAnswered, langs) {
                let answered2 = alreadyAnswered + `<li>${this.question(tree)} : YES </li>`
                let tree2 = tree.right;
                let question2 = this.question(tree2);
                let langs2 = langs.filter(item => {
                    return item.features.some( f => tree.rule.feature.id == f.feature.id && tree.rule.value <= f.value );
                });

                return [question2, answered2, tree2, langs2];
            },

            traverseTreeLeft(tree, alreadyAnswered) {
                let answered2 = alreadyAnswered + `<li>${this.question(tree)} : NO </li>`
                let tree2 = tree.left;
                let question2 = this.question(tree2);

                return [question2, answered2, tree2];
            }
        };

        const featureDescription = (feature) => {
            if (feature.feature.fieldType.min) {
                return `${feature.feature.description} [${feature.feature.fieldType.min}/${feature.feature.fieldType.max}] = ${feature.value}`
            }
            else {
                return feature.feature.description
            }
        };


    </script>
</body>
</html>